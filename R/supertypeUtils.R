#' Gets a supertype from a type name, with various levels of depth
#' @param types A type name or vector of type names, or a data frame containing databaseType
#'  (or databaseType.to and from) columns, or a neuronBag object
#' @param level Depth of the supertype. Possible values are 1,2 or 3 (default 2), 1 being the finest
#' subdivision and 3 the coarsest
#' @details For example, at level 1 delta0 neurons are just divided in DeltaA to K, at level 2 they are
#' D0, and at level 3 they are FB Interneurons
#' @return an object of the same type as the \code{types} inputed, possibly with extra columns
#'
#' @export
supertype <- function(types,level=2,unicodeDelta=TRUE){UseMethod("supertype")}

#' @export
supertype.character <- function(types,level=2,unicodeDelta=TRUE){
  supertype <- types
  supertype[is.na(types)] <- "Other"
  supertype[is.null(types)] <- "Other"
  
  supertype[grepl("^FB.*",types)] <- stringr::str_extract(types,"FB[1-9]")[grepl("^FB.*",types)]
  supertype[grepl("^vDelta.*",types)] <- stringr::str_extract(types,"vDelta[A-O]")[grepl("^vDelta.*",types)]
  supertype[grepl("^hDelta.*",types)] <- stringr::str_extract(types,"hDelta[A-M]")[grepl("^hDelta.*",types)]
  supertype[grepl("^FC.*",types)] <- stringr::str_extract(types,"FC[1-9]")[grepl("^FC.*",types)]
  supertype[grepl("^FS.*",types)] <- stringr::str_extract(types,"FS[1-9]")[grepl("^FS.*",types)]
  supertype[grepl("^FR.*",types)] <- "FR"
  supertype[grepl("^EL.*",types)] <- "EL"
  supertype[grepl("^PFR.*",types)] <- "PFR"
  supertype[grepl("^PFN.*",types)] <- stringr::str_extract(types,"PFN[a|d|m|p|v]")[grepl("^PFN.*",types)]
  supertype[types %in% c("L-L(c)1","AoL-L(c)","L-LC(c)1","VeL-CLVe(c)1","L-Lic(c)","VeL-LVeC(c)",
                        "CL-LC(c)","VeL-LVe(c)2","CL-L(c)1","L-LC(c)2","VeLC-L(c)","CL-L(c)2",
                        "VeL-L(c)","CL-L(c)2","VeLC-LVe(c)3","VeL-LC(c)","L-L(c)2")] <- "L-L(c)"
  supertype[grepl("^C.*Sm$",types)] <- "C-Sm"
  supertype[types %in% c("CL-AtIb(c)1","CL-AtIb(c)2","CL-IbAtl(b)1","CL-SmIb","CL-AtIb(b)2","CL-AtIb(b)3")] <- "CL-Ib"
  supertype[types %in% c("LCPl-SmSi","WplL-Sm")] <- "L-Sm"
  supertype[types %in% c("IbSpVeL-(LIb)(c)Sm(b)","VeLC-(LC)(c)Sm(b)")] <- "L-Sm(b)"
  supertype[types %in% c("L-VeSpIp","L-EpVeSp","L-VeSp","LVe-SpIp","LW-Sp")] <-  "L-Sp"
  supertype[startsWith(types,"L-Ve")] <- "L-Ve"
  supertype[startsWith(types,"L-WP")] <- "L-WP"
  supertype[startsWith(types,"LVe")] <- "LVe"
  supertype[startsWith(types,"Pl-C")] <- "Pl-C"
  supertype[types %in% c("SpVeL-(?)(c)","SpVeL-LSpIp(c)1","SpVeL-LSpIp(c)2")] <- "SpVeL-X(c)"
  supertype[types %in% c("VeLC-CLVe(c)","VeLC-LVe(c)")] <- "VeL-LVe"
  supertype[types %in% c("WL-(X)(c)","VeWL-VeX(c)","LW-X(c)")] <- "WL-X(c)"
  if (unicodeDelta){supertype <- stringr::str_replace(supertype,"Delta","\u0394")}
  
  if (level == 1){return(supertype)}

  supertype[grepl("^FB.*",types)] <- "FBt"
  supertype[grepl("^vDelta.*",types)] <- "vDelta"
  supertype[grepl("^hDelta.*",types)] <- "hDelta"
  supertype[grepl("^PFL.*",types)] <- "PFL"
  supertype[grepl("^PFN.*",types)] <- "PFN"
  supertype[grepl("^PFR.*",types)] <- "PFR"
  supertype[grepl("^PEN.*",types)] <- "PEN"
  supertype[grepl("^LN.*",types)] <- "LN"
  supertype[grepl("^ExR.*",types)] <- "ExR"
  supertype[grepl("^FC.*",types)] <- "FC"
  supertype[grepl("^FR.*",types)] <- "FR"
  supertype[grepl("^FS.*",types)] <- "FS"
  supertype[grepl("^LCN.*",types)] <- "LN"
  supertype[grepl("^EL.*",types)] <- "EL"
  supertype[grepl("^ER[1-6].*",types)] <- "Ring"
  supertype[grepl("^SA.*",types)] <- "SA"
  supertype[grepl("SpsP.*",types)] <- "SPS-PB"
  supertype[grepl("^OA_V.*",types)] <- "OA"
  supertype[grepl("^P[1|6].*",types)] <- "P"

  if (unicodeDelta){supertype <- stringr::str_replace(supertype,"Delta","\u0394")}
  if (level == 2){return(supertype)}

  supertype[grepl("^Delta7|P[1|6].*",types)] <- "PB Interneurons"
  supertype[grepl("^PF.*",types)] <- "FB Columnar"
  supertype[grepl("^EPG.*|^PEG.*|^PEN.*|^EL.*",types)] <- "EB Columnar"
  supertype[grepl("^FC.*|^FR.*|^FS.*",types)] <- "FB Output"
  supertype[grepl("^FB[1-9].*",types)] <- "FB Tangential"
  supertype[grepl("^[h|v]Delta.*",types)] <- "FB Interneuron"

  supertype[types == supertype] <- "Other"
  if (unicodeDelta){supertype <- stringr::str_replace(supertype,"Delta","\u0394")}
  supertype
}

#' @export
supertype.neuronBag <- function(types,unicodeDelta=TRUE){
  for (lev in 1:3){
    for (ty in c(".from",".to")){
      for (tab in c("inputs","outputs","inputs_raw","outputs_raw")){
        types[[tab]][[paste0("supertype",ty,lev)]] <- supertype(types[[tab]][[paste0("databaseType",ty)]],level=lev,unicodeDelta=unicodeDelta)
      }
    }
    types$names[[paste0("supertype",lev)]] <-  supertype(types$names[[paste0("databaseType")]],level=lev,unicodeDelta=unicodeDelta)
    types$outputsTableRef[[paste0("supertype",lev)]] <-  supertype(types$outputsTableRef[[paste0("databaseType")]],level=lev,unicodeDelta=unicodeDelta)
  }
  types
}

#' @export
supertype.data.frame <- function(types,level=1:3,unicodeDelta=TRUE){
  renamable <- names(types)[names(types) %in% c("databaseType","databaseType.from","databaseType.to")]
  for (lev in level){
    for (ty in renamable){
        types[[paste0(sub("databaseType","supertype",ty),lev)]] <- supertype(types[[ty]],level=lev,unicodeDelta=unicodeDelta)
    }
  }
  types
}

#' @export
supertype.NULL <- function(types,level=NULL){
  return(NULL)
}

#' Select a set of Supertypes from a Supertypes table as the one generated by supertype (when applied to a data frame)
#' @param supertypeTable A supertypes table as returned by \code{supertype}
#' @param default_level An integer specifying which Supertype level to use by default
#' @param exceptions A list of the form list(nameOfType = level) where nameOfType is the name of
#' Supertypes at level \code{exceptionLevelMatch} for which one want to use a different level of description
#' @param exceptionLevelMatch What level to use in the \code{exceptions} list
#' @return a data.frame with the same columns as those returned by \code{supertype} with an extra \code{type} column
#' containing the desired set
#' @details this is to supertypes what \code{selectRoiSet} is to ROIs
#' @seealso \code{supertype}, \code{selectRoiSet}
#' @export
selectSupertypeSet <- function(supertypeTable,default_level=2,exceptions=NULL,exceptionLevelMatch = default_level){
  supertypeTable$supertype0 <- supertypeTable$databaseType
  if (!is.null(exceptions)){
    levelEx <- paste0("supertype",exceptionLevelMatch)
    normalTypes <- supertypeTable %>% filter(!((!!as.name(levelEx)) %in% names(exceptions))) %>%
      mutate(type = (!!as.name(paste0("supertype",default_level))))

    exceptionsTypes <- supertypeTable %>% filter(((!!as.name(levelEx)) %in% names(exceptions)))

    typesEx <- as.character(exceptionsTypes[[levelEx]])
    customLev <- sapply(typesEx,function(r) paste0("supertype",exceptions[[r]]))
    exceptionsTypes$type <- sapply(1:length(customLev),function(i) as.character(exceptionsTypes[[customLev[i]]][i]))

    types <- bind_rows(normalTypes,exceptionsTypes)
  }else{
    types <- supertypeTable %>% mutate(type = (!!(as.name(paste0("supertype",default_level)))))
  }

  types <- types %>% arrange(supertype3) %>%
    mutate(type = factor(type,levels=c("Other",unique(type))))

  return(distinct(types))
}

#' Create a consistent palette for supertypes for plotting
#' @param typeSelection A supertype selection as returned by \code{selectSupertypeSet}
#' @param my_palette A discrete color palette to use
#' @return A named vector of colors (for example to be used in ggplot2's \code{scale_color_manual})
#' @seealso \code{selectSupertypeSet}, \code{roisPalette}
#' @export
typesPalette <- function(typeSelection,my_palette=paletteer::paletteer_d("Polychrome::palette36")){
  typeSelection <- unique(c(as.character(typeSelection),"Other"))
  if (length(typeSelection)>36) warning(paste0(length(typeSelection)," levels in your palette, this is likely too many."))
  pal <- my_palette[1:length(typeSelection)]
  oPos <- which(typeSelection=="Other")
  typeSelection[c(2,oPos)] <- typeSelection[c(oPos,2)]  ## Exchange to get "other" at a neutral color
  names(pal) <- typeSelection
  pal
}
